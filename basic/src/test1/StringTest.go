package test1

import (
	"bytes"
	"golang.org/x/text/encoding/simplifiedchinese"
	"golang.org/x/text/transform"
	"io/ioutil"
	"log"
	"reflect"
	"strings"
	"unsafe"
)

type Student struct {
	Sid   int
	Sname string
	_     struct{} // è¡¨ç¤ºåœ¨åˆå§‹åŒ–ç»“æ„ä½“æ—¶ï¼Œå¿…é¡»æ˜¾ç¤ºçš„å†™å‡ºå±æ€§åï¼Œå³ä¸å…è®¸{1,"leo"}è¿™ç§å†™æ³•ï¼Œå¿…é¡»æ˜¯{Sid:1,Sname:"leo"}
}

/*
	goä¸­stringçš„ç»“æ„å¦‚ä¸‹:
	type stringStruct struct {
		// å¤´éƒ¨æŒ‡å‘å­—èŠ‚æ•°ç»„
		str unsafe.Pointer
		// é•¿åº¦
		len int
	}
	å­—ç¬¦ä¸²æ“ä½œé€šå¸¸ä¼šåœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œå±Šæ—¶ä¼šæœ‰å¤§é‡çš„å­—ç¬¦ä¸²å¯¹è±¡éœ€è¦è¿›è¡Œåƒåœ¾å›æ”¶
	å¯ä»¥ä½¿ç”¨[]byteç¼“å­˜æ± ï¼Œæˆ–åœ¨æ ˆä¸Šè‡ªè¡Œæ‹¼è£…ç­‰æ–¹å¼æ¥å®ç° zero-gargage
*/
func StringTest() {
	/*
		string å­—ç¬¦ä¸²å…è®¸:
		16è¿›åˆ¶: \x61
		8è¿›åˆ¶: \142
		unicode: \u0041
	*/
	s := "æµ‹è¯•\x61\142\u0041"
	log.Printf("% x \n %s \n %T \n", s, s, s)

	/*
		é»˜è®¤stringçš„å€¼ä¸º "" è€Œä¸æ˜¯nil
	*/
	var s1 string
	log.Printf("% x \n %s \n %T \n", s1, s1, s1)

	/*
		ä½¿ç”¨ `` å¤„ç†ä¸éœ€è¦è½¬ä¹‰çš„å­—ç¬¦ä¸²ï¼Œè€Œä¸”æ”¯æŒæ¢è¡Œ
	*/
	s2 := `abcde \n \s \d \r\n
	æ¢è¡Œ
ä¸å¸¦ç©ºæ ¼æ¢è¡Œ`
	log.Printf("%s \n", s2)
}

func StringForLoopTest() {
	s := "æµ‹è¯•\x61\142\u0041"
	/*
		åŸºäºbyteçš„éå†
	*/
	for i := 0; i < len(s); i++ {
		log.Printf("%d,%c \n", i, s[i])
	}
	log.Println("==================================")
	/*
		åŸºäºå­—ç¬¦ï¼ˆruneï¼‰çš„éå†
		è¿”å› i(æ•°ç»„åºå·),c(unicodeå­—ç¬¦)
	*/
	for i, c := range s {
		log.Printf("%d,%c,%c \n", i, s[i], c)
	}

}

/*
	goçš„å­—ç¬¦ä¸²å¤´ç»“æ„å’Œæ•°ç»„çš„å¤´ç»“æ„*éƒ¨åˆ†ç›¸åŒ*
*/
func StringTransformTest() {
	s := "hello world!"

	// å­—ç¬¦ä¸²è½¬æ•°ç»„ï¼Œæ•°ç»„è½¬å­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸€å®šä¼šå¯¼è‡´é‡æ–°åˆ†é…å†…å­˜
	/*
		%x ä¸º s å˜é‡æ‰€è¡¨ç¤ºçš„åœ°å€
		%p ä¸º s æŒ‡å‘çš„æœ€ç»ˆåœ°å€ï¼Œç”±äºä¸æ˜¯æŒ‡é’ˆç±»å‹ï¼Œå› æ­¤æ²¡æœ‰æŒ‡å‘åœ°å€ï¼Œå› æ­¤äº§ç”Ÿå‘Šè­¦
	*/
	log.Printf("å­—ç¬¦ä¸²å˜é‡[s]çš„åœ°å€: 0x%x \n", &s)
	log.Printf("å­—ç¬¦ä¸²å˜é‡[s]çš„å€¼: %s \n", s)
	//b1ä¸ºæŒ‡é’ˆç±»å‹(*string)
	b1 := &s
	/*
		%x ä¸ºb1å˜é‡æ‰€è¡¨ç¤ºçš„åœ°å€ä¸º
		%p ä¸º s æŒ‡å‘çš„æœ€ç»ˆåœ°å€,ä¹Ÿå°±æ˜¯çœŸæ­£stringå€¼æ‰€åœ¨çš„åœ°å€
	*/
	log.Printf("å­—ç¬¦ä¸²æŒ‡é’ˆ[b1]çš„åœ°å€: 0x%x \n", &b1)
	log.Printf("å­—ç¬¦ä¸²æŒ‡é’ˆ[b1]æ‰€æŒ‡å‘çš„çœŸæ­£çš„æ•°æ®åœ°å€: %p \n", b1)
	log.Printf("å­—ç¬¦ä¸²æŒ‡é’ˆ[b1]çš„å€¼: %s \n", *b1)

	// æ•°ç»„çš„åœ°å€å°±æ˜¯é¦–åœ°å€ï¼Œä¹Ÿå°±æ˜¯ &b2[0]
	b2 := []byte(s)
	// å˜é‡åœ°å€å€¼å–ä¸åˆ°ï¼Œå› ä¸ºæ•°ç»„å˜é‡çš„åœ°å€å°±æ˜¯é¦–å…ƒç´ çš„åœ°å€
	log.Printf("æ•°ç»„å˜é‡[b2]çš„åœ°å€: 0x%x \n", &b2)
	log.Printf("æ•°ç»„å˜é‡[b2]çš„å€¼: [% x] \n", b2)
	// é¦–å…ƒç´ çš„å€¼å’Œå­—ç¬¦ä¸²åœ°å€çš„å€¼ä¸åŒï¼Œè¯´æ˜åšäº†æ•°ç»„æ‹·è´ï¼Œå› ä¸ºå­—ç¬¦ä¸²çš„åœ°å€ä¹Ÿæ˜¯åº•å±‚æ•°ç»„é¦–å…ƒç´ çš„å€¼
	log.Printf("æ•°ç»„å˜é‡[b2<é¦–å…ƒç´ >]çš„åœ°å€: 0x%x \n", &b2[0])
	log.Printf("æ•°ç»„å˜é‡[b2]çš„å€¼: %s \n", b2)

	s = string(b2)
	log.Printf("å­—ç¬¦ä¸²å˜é‡[s]çš„åœ°å€: 0x%x \n", &s)
	log.Printf("å­—ç¬¦ä¸²å˜é‡[s]çš„å€¼: %s \n", s)
	/*
		ä½¿è½¬æ¢ä¸äº§ç”Ÿæ•°ç»„æ‹·è´
	*/
	// å°†sæŒ‡é’ˆåœ°å€è½¬æ¢ä¸º unsafe.Pointer
	p := unsafe.Pointer(&s)
	// å°†unsafe.Pointer è½¬æ¢ä¸º uintptr(å…¶å®å°±æ˜¯ä¸€ä¸ªuintï¼Œç”¨äºå­˜æ”¾æŒ‡é’ˆåœ°å€)ï¼Œå¹¶ä¸”å¯ä»¥è¿›è¡Œæ•°å­¦è¿ç®—
	// è¿™é‡Œåªåšæ¼”ç¤ºï¼Œè½¬æ¢è¿‡ç¨‹ä¸­å¯ä»¥ä¸éœ€è¦è¯¥æ­¥éª¤
	pp := uintptr(p)
	// å¯ä»¥çœ‹åˆ° ppçš„å€¼å…¶å®å°±æ˜¯ sçš„åœ°å€
	log.Printf("uintptrå˜é‡[pp]çš„åœ°å€: 0x%x \n", &pp)
	log.Printf("uintptrå˜é‡[pp]çš„å€¼: %d \n", pp)
	// å°† unsafe.Pointer ç±»å‹å¼ºè½¬æˆ å­—èŠ‚æ•°ç»„æŒ‡é’ˆ
	bp := (*[]byte)(p)
	// å¯ä»¥çœ‹åˆ°æ‰“å°å‡ºæ¥ bp æ‰€æŒ‡å‘çš„åœ°å€å°±æ˜¯sçš„åœ°å€
	//  &(*bp)[0] è¡¨ç¤º bpå–çœŸå®çš„æ•°ç»„ï¼Œä¹‹åæ‰¾æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€
	log.Printf("å­—èŠ‚æ•°ç»„æŒ‡é’ˆ[bp]çš„åœ°å€: 0x%x \n", &bp)
	log.Printf("å­—èŠ‚æ•°ç»„æŒ‡é’ˆ[bp]æ‰€æŒ‡å‘çš„çœŸæ­£çš„æ•°æ®åœ°å€: %p \n", bp)
	log.Printf("å­—èŠ‚æ•°ç»„æŒ‡é’ˆ[bp]çš„æ•°ç»„å€¼: [% x] \n", *bp)
	log.Printf("å­—èŠ‚æ•°ç»„æŒ‡é’ˆ[bp]çš„å­—ç¬¦ä¸²å€¼: %s \n", *bp)
	// goé‡Œå…è®¸ç›´æ¥åˆ©ç”¨ä¸‹æ ‡indexè®¿é—®å­—ç¬¦ä¸²çš„å­—èŠ‚æ•°ç»„ï¼Œä½†ä¸èƒ½å–åœ°å€
	log.Printf("å­—ç¬¦ä¸²[s]çš„é¦–å­—èŠ‚æ˜¯: %d", s[0])
	s1 := s[:3]
	s2 := s[5:]
	s3 := s[2:3]
	log.Printf("å­—ç¬¦ä¸²[s]çš„å­—èŠ‚æ•°ç»„æ˜¯: [% x] , å­—ç¬¦ä¸²æ˜¯: %s", s1, s1)
	log.Printf("å­—ç¬¦ä¸²[s]çš„å­—èŠ‚æ•°ç»„æ˜¯: [% x] , å­—ç¬¦ä¸²æ˜¯: %s", s2, s2)
	log.Printf("å­—ç¬¦ä¸²[s]çš„å­—èŠ‚æ•°ç»„æ˜¯: [% x] , å­—ç¬¦ä¸²æ˜¯: %s", s3, s3)
	// ä¸‹é¢è¯­å¥ä¼šæœ‰ç¼–è¯‘é”™è¯¯: cannot take address of (s[0])
	// log.Printf("å­—ç¬¦ä¸²[s]çš„é¦–å­—èŠ‚æ˜¯: %p", &(s[0]))
	// ç›´æ¥å°†s1çš„å­—ç¬¦ä¸²åœ°å€è½¬æˆPointerï¼Œç„¶åå¼ºè½¬å­—ç¬¦ä¸²ï¼ˆb2æ˜¯å­—èŠ‚æ•°ç»„ï¼‰
	log.Printf("å°†b2ç›´æ¥è½¬æ¢æˆå­—ç¬¦ä¸²: %s", *(*string)(unsafe.Pointer(&b2)))
	// å¯ä»¥ä½¿ç”¨appendç›´æ¥å°†å­—ç¬¦ä¸²æ·»åŠ åˆ°å­—èŠ‚æ•°ç»„ä¸­å»ï¼Œä½†æ˜¯ç”±äºstringä¸å¯å˜ï¼Œå› æ­¤è¯¥æ“ä½œä¼šäº§ç”Ÿåˆ†é…æ–°å†…å­˜å¹¶å¤åˆ¶æ•°æ®
	var b3 []byte
	b3 = append(b3, s...)
	log.Printf("æ•°ç»„[b3]åœ°å€ä¸º: %p,å€¼ä¸º: [% x]", &b3, b3)
	/*
		ç¼–è¯‘å™¨ä¼šå¯¹ä»¥ä¸‹ä¸¤ç§æƒ…å†µè¿›è¡Œä¼˜åŒ–ï¼Œä»¥é¿å…é¢å¤–çš„åˆ†é…å’Œå¤åˆ¶æ“ä½œ:
		  Â·åœ¨å°†[]byteè½¬æ¢æˆstring keyï¼Œå»map[string]ä¸­æŸ¥è¯¢çš„æ—¶å€™
		  Â·å°†stringè½¬æ¢æˆ[]byte,è¿›è¡Œfor rangeè¿­ä»£çš„æ—¶å€™ï¼Œç›´æ¥å–å­—èŠ‚èµ‹å€¼ç»™å±€éƒ¨å˜é‡çš„æ—¶å€™
		@TODO æœªéªŒè¯
	*/
	m1 := map[string]string{
		"key1": "value",
	}
	key := []byte("key1")
	log.Printf("å­—èŠ‚æ•°ç»„å˜é‡[key]çš„åœ°å€æ˜¯: %p", &key[0])
	x, ok := m1[string(key)]
	log.Printf("map[\"key1\"]çš„å€¼æ˜¯: %s, è·å–map[\"key1\"]çš„æ•°æ®æ˜¯å¦æˆåŠŸ(bool): %t", x, ok)

	log.Printf("s string header: %#v", (*reflect.StringHeader)(unsafe.Pointer(&s)))
}

// ä»¥+å·çš„æ–¹å¼æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œæ¯ä¸€æ¬¡éƒ½è¦é‡æ–°åˆ†é…å†…å­˜ï¼Œæ„å»ºå¤§å‹å­—ç¬¦ä¸²æ—¶å€™å®¹æ˜“é€ æˆæ€§èƒ½é—®é¢˜
func StringPlusTest() string {
	var s string
	for i := 0; i < 1000; i++ {
		s += "*"
	}
	return s
}

/*
	strings.Join æ–¹æ³•ä¼šç»Ÿè®¡æ‰€æœ‰å‚æ•°é•¿åº¦ï¼Œå¹¶ä¸€æ¬¡æ€§å®Œæˆå†…å­˜åˆ†é…([]byte)
	ä¹‹åå†ç”¨copyæ–¹å¼æ‹·è´æ•°æ®åˆ° []byte
*/
func StringJoinTest() string {
	s := make([]string, 1000)
	for i := 0; i < 1000; i++ {
		s[i] = "*"
	}
	return strings.Join(s, "")
}

/*
	ä½¿ç”¨bytes.Buffer æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œæ€§èƒ½è¾ƒå¥½
*/
func StringByteBufTest() string {
	var b bytes.Buffer
	b.Grow(1000)
	for i := 0; i < 1000; i++ {
		b.WriteString("*")
	}
	return b.String()
}

/*
	è½¬ç  UTF8 -> GBK
*/
func TransCharacter() {
	s1 := "ä½ å¥½ğŸ§­"
	s2 := "ä½ å¥½"
	// vscodeé»˜è®¤utf8
	// å¯ä»¥çœ‹åˆ° ä¸­æ–‡3ä¸ªå­—èŠ‚ï¼Œè¡¨æƒ…4ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ä¸¤ä¸ªä¸­æ–‡+è¡¨æƒ…ä¸€å…±æ˜¯10ä¸ªå­—èŠ‚
	bp := (*[]byte)(unsafe.Pointer(&s1))
	log.Printf("[UTF8]->s1-> %x,%+v \n", &bp, bp)
	// è½¬ç ,è½¬GBK
	bp = (*[]byte)(unsafe.Pointer(&s2))
	log.Printf("[UTF8]->s1-> %x,%+v \n", &bp, bp)
	reader := transform.NewReader(bytes.NewReader(([]byte)(s1)), simplifiedchinese.GBK.NewEncoder())
	newBytes, _ := ioutil.ReadAll(reader)
	result := string(newBytes)
	log.Printf("Result: %s,[% x]", result, newBytes)
}
